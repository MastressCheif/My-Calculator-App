<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Calculator App</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <div class="calculator-wrapper">
            <div class="calculator">
                <div class="display-container">
                    <div class="display-content">
                        <input type="text" id="inputBox" class="inputBox" value="0" readonly />
                        <div class="erase-btn-container">
                            <button class="erase-btn" onclick="eraseLast()">âŒ«</button>
                        </div>
                    </div>
                    <div class="divider-line"></div>
                </div>
                <div class="buttons">
                    <button class="ACButton" onclick="btnACPressed()">C</button>
                    <button class="operatorButton" onclick="bracketBtnPressed()">()</button>
                    <button class="operatorButton" onclick="percentPressed()">%</button>
                    <button class="operatorButton" onclick="operatorBtnPressed('/')">/</button>

                    <button class="digitButton" onclick="digitBtnPressed(7)">7</button>
                    <button class="digitButton" onclick="digitBtnPressed(8)">8</button>
                    <button class="digitButton" onclick="digitBtnPressed(9)">9</button>
                    <button class="operatorButton" onclick="operatorBtnPressed('*')">x</button>

                    <button class="digitButton" onclick="digitBtnPressed(4)">4</button>
                    <button class="digitButton" onclick="digitBtnPressed(5)">5</button>
                    <button class="digitButton" onclick="digitBtnPressed(6)">6</button>
                    <button class="operatorButton" onclick="operatorBtnPressed('-')">-</button>

                    <button class="digitButton" onclick="digitBtnPressed(1)">1</button>
                    <button class="digitButton" onclick="digitBtnPressed(2)">2</button>
                    <button class="digitButton" onclick="digitBtnPressed(3)">3</button>
                    <button class="operatorButton" onclick="operatorBtnPressed('+')">+</button>

                    <button class="digitButton" onclick="toggleSign()">+/-</button>
                    <button class="digitButton" onclick="digitBtnPressed(0)">0</button>
                    <button class="operatorButton" onclick="operatorBtnPressed('.')">.</button>
                    <button class="equalButton" onclick="equalsBtnPressed()">=</button>
                </div>
            </div>
        </div>
        <script>
            var newLine = true;

            function appendToInput(char) {
                var inputBox = document.getElementById("inputBox");
                if (inputBox.value === "0" || newLine) {
                    inputBox.value = char;
                    newLine = false;
                } else {
                    inputBox.value += char;
                }
            }

            function digitBtnPressed(button){
                appendToInput(button);
            }

            function operatorBtnPressed(operator){
                appendToInput(operator);
            }

            function btnACPressed(){
                document.getElementById("inputBox").value = 0;
                newLine = true;
            }

            // Smart bracket button (Samsung style)
            function bracketBtnPressed() {
                var inputBox = document.getElementById("inputBox");
                var input = inputBox.value;
                // Count open and close brackets
                let open = (input.match(/\(/g) || []).length;
                let close = (input.match(/\)/g) || []).length;
                // Check last char (ignore spaces)
                let lastChar = input.trim().slice(-1);

                // Insert '(' if:
                // - At start, or after an operator or '('
                if (
                    input === "0" ||
                    newLine ||
                    lastChar === "" ||
                    lastChar === "(" ||
                    "+-*/(".includes(lastChar)
                ) {
                    if (input === "0" || newLine) inputBox.value = "(";
                    else inputBox.value += "(";
                    newLine = false;
                }
                // Insert ')' if there are more opens than closes and last char is not operator or '('
                else if (open > close && !"()+-*/".includes(lastChar)) {
                    inputBox.value += ")";
                    newLine = false;
                }
                // Otherwise, insert '('
                else {
                    inputBox.value += "(";
                    newLine = false;
                }
            }

            // Enhanced equals function: supports %, (), and all operators
            function equalsBtnPressed(){
                var input = document.getElementById("inputBox").value;
                try {
                    // Replace x with * for multiplication
                    input = input.replace(/x/g, '*');
                    // Replace all percentage usages with appropriate math
                    input = handlePercentages(input);

                    // Remove any trailing operators
                    input = input.replace(/[\+\-\*\/\.]$/, "");

                    var result = eval(input);
                    document.getElementById("inputBox").value = result;
                    newLine = true;
                } catch (e) {
                    document.getElementById("inputBox").value = "Error";
                    newLine = true;
                }
            }

            function eraseLast() {
                let inputBox = document.getElementById("inputBox");
                let currentValue = inputBox.value;
                if (currentValue.length === 1 || currentValue === "0" || newLine) {
                    inputBox.value = "0";
                    newLine = true;
                } else {
                    inputBox.value = currentValue.slice(0, -1);
                }
            }

            // Handles % button press (like a real calculator)
            function percentPressed() {
                var inputBox = document.getElementById("inputBox");
                var input = inputBox.value;

                // Find last number in the input
                let match = input.match(/(.+?)([\d\.]+)$/);
                if (match) {
                    const before = match[1];
                    const number = match[2];
                    // If before ends with +, -, *, or /, we can handle percentage
                    let opMatch = before.match(/([\+\-\*\/])\s*$/);
                    if (opMatch && (opMatch[1] === "+" || opMatch[1] === "-")) {
                        // e.g. 200+10% => 200 + (200*10/100)
                        // Find the base value before the operator
                        let baseMatch = before.match(/(.*?)([\d\.]+)\s*[\+\-\*\/]\s*$/);
                        if (baseMatch) {
                            let base = baseMatch[2];
                            let op = opMatch[1];
                            let percentValue = "(" + base + "*" + number + "/100)";
                            let newInput = baseMatch[1] + base + op + percentValue;
                            inputBox.value = newInput;
                            newLine = false;
                            return;
                        }
                    }
                    // Otherwise, just divide the number by 100
                    inputBox.value = before + (parseFloat(number) / 100);
                    newLine = false;
                    return;
                }
                // fallback: divide whole input by 100
                try {
                    var result = eval(input) / 100;
                    inputBox.value = result;
                    newLine = true;
                } catch (e) {
                    inputBox.value = "Error";
                    newLine = true;
                }
            }

            // Helper: Replaces all "number%" in an expression with "number/100"
            // Also enhances expressions like "200+10%" => "200+(200*10/100)"
            function handlePercentages(expr) {
                // First handle patterns like 200+10%
                expr = expr.replace(/(\d+(\.\d+)?)([\+\-])(\d+(\.\d+)?)%/g, function(match, base, _, op, percent){
                    return base + op + "(" + base + "*" + percent + "/100)";
                });
                // Then handle any remaining N% as (N/100)
                expr = expr.replace(/(\d+(\.\d+)?)%/g, function(match, p1){
                    return "(" + p1 + "/100)";
                });
                return expr;
            }

            function toggleSign() {
                let inputBox = document.getElementById("inputBox");
                let input = inputBox.value;
                // If the input is a number, simply toggle its sign
                // If it's an expression, try to toggle the last number
                if (/^-?\d+(\.\d+)?$/.test(input)) {
                    if (input.startsWith("-")) {
                        inputBox.value = input.slice(1);
                    } else if (input !== "0") {
                        inputBox.value = "-" + input;
                    }
                } else {
                    // Try to find last number and toggle its sign
                    let match = input.match(/(.*?)(-?\d+(\.\d+)?)([^\d.]*)$/);
                    if (match) {
                        let before = match[1];
                        let number = match[2];
                        let after = match[4];
                        if (number.startsWith("-")) {
                            number = number.slice(1);
                        } else {
                            number = "-" + number;
                        }
                        inputBox.value = before + number + after;
                    }
                }
            }
        </script>
    </body>
</html>